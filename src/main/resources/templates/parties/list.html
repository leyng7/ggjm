<!DOCTYPE html>
<html
        lang="ko"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{layout/frontLayout}"
>

<div layout:fragment="content">

    <div id="map" style="width:100%;height:90vh;"></div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5c1b073aed2430dd7b1f88c8600a72ab"></script>
    <script>
        var container = document.getElementById('map');
        var options = {
            center: new kakao.maps.LatLng(36.3504567, 127.38263),
            level: 7
        };

        var map = new kakao.maps.Map(container, options);

        fetch('/parties/all')
            .then(response => response.json())
            .then(partyList => {

                let positions = [];
                for (let party of partyList) {

                    const content =
                        `<div>
                           <div class="card mb-3" style="width: 15rem;">
                               <div class="card-header d-flex justify-content-between">
                                    <div>${party.name} (${party.partyMembersSize}/4)</div>
                                    <span class="badge rounded-pill bg-primary">${party.restaurant.type}</span>
                               </div>
                               <div class="card-body small">
                                    ${party.restaurant.name}
                               </div>
                           </div>
                        </div>`;

                    let parseParty = {
                        id: party.id,
                        content,
                        latlng: new kakao.maps.LatLng(party.restaurant.let, party.restaurant.lng)
                    }
                    positions.push(parseParty);
                }


                for (let position of positions) {

                    const marker = new kakao.maps.Marker({
                        map: map,
                        position: position.latlng
                    });

                    // 마커에 표시할 인포윈도우를 생성합니다
                    const infowindow = new kakao.maps.InfoWindow({
                        content: position.content
                    });

                    // 마커에 mouseover 이벤트와 mouseout 이벤트를 등록합니다
                    // 이벤트 리스너로는 클로저를 만들어 등록합니다
                    // for문에서 클로저를 만들어 주지 않으면 마지막 마커에만 이벤트가 등록됩니다
                    kakao.maps.event.addListener(marker, 'click', handleClick(position.id));
                    kakao.maps.event.addListener(marker, 'mouseover', makeOverListener(map, marker, infowindow));
                    kakao.maps.event.addListener(marker, 'mouseout', makeOutListener(infowindow));

                }

            })


        function handleClick(id) {
            return function () {
                window.location.href = '/parties/' + id;
            }
        }

        // 인포윈도우를 표시하는 클로저를 만드는 함수입니다
        function makeOverListener(map, marker, infowindow) {
            return function () {
                infowindow.open(map, marker);
            };
        }

        // 인포윈도우를 닫는 클로저를 만드는 함수입니다
        function makeOutListener(infowindow) {
            return function () {
                infowindow.close();
            };
        }

    </script>
</div>

</body>
</html>
